files:
  "/tmp/setup-documentdb-ssl.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      set -e
      
      echo "Starting DocumentDB SSL setup..."
      
      # Download the DocumentDB certificate
      wget -O /tmp/rds-combined-ca-bundle.pem https://truststore.pki.rds.amazonaws.com/global/global-bundle.pem
      
      # Create directory for truststore
      mkdir -p /etc/pki/tls/certs
      
      # Remove existing truststore if it exists
      rm -f /etc/pki/tls/certs/documentdb-truststore.jks
      
      # Create the truststore
      keytool -importcert -trustcacerts \
        -file /tmp/rds-combined-ca-bundle.pem \
        -keystore /etc/pki/tls/certs/documentdb-truststore.jks \
        -storepass changeit \
        -alias docdb-ca \
        -noprompt
      
      echo "DocumentDB truststore created successfully at /etc/pki/tls/certs/documentdb-truststore.jks"
      
      # Verify the truststore
      keytool -list -keystore /etc/pki/tls/certs/documentdb-truststore.jks -storepass changeit
      
      exit 0

container_commands:
  01_download_rds_cert:
    command: "wget https://truststore.pki.rds.amazonaws.com/us-east-1/us-east-1-bundle.pem -O /tmp/rds-us-east-1.pem"
  02_import_to_java_cacerts:
    command: "keytool -importcert -noprompt -trustcacerts -alias rds-us-east-1-root -file /tmp/rds-us-east-1.pem -keystore $JAVA_HOME/lib/security/cacerts -storepass changeit"
    ignoreErrors: true

option_settings:
  aws:elasticbeanstalk:application:environment:
    JAVA_TOOL_OPTIONS: "-Djavax.net.ssl.trustStore=/etc/pki/tls/certs/documentdb-truststore.jks -Djavax.net.ssl.trustStorePassword=changeit"